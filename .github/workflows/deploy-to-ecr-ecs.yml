name: Build → Push to ECR → Update ECS

on:
  push:
    branches: [ main ]

env:
  ECR_REPOSITORY: devops-microservice
  CONTAINER_NAME: container
  CONTAINER_PORT: 80
  CLUSTER_NAME: devops-cluster
  SERVICE_NAME: ecs-task-service-c7qhc25h    # update if your service name is different

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} \
            | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

      - name: Build Docker image
        run: |
          docker build -t $ECR_REPOSITORY .

      - name: Tag image for ECR
        run: |
          docker tag $ECR_REPOSITORY:latest ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/$ECR_REPOSITORY:latest

      - name: Create ECR repo if not exists
        run: |
          aws ecr describe-repositories --repository-names $ECR_REPOSITORY || \
          aws ecr create-repository --repository-name $ECR_REPOSITORY

      - name: Push image to ECR
        run: |
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/$ECR_REPOSITORY:latest

      - name: Register new task definition and update ECS service
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
          TASK_FAMILY: devops-microservice-task
          CLUSTER_NAME: ${{ env.CLUSTER_NAME }}
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
          CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
          CONTAINER_PORT: ${{ env.CONTAINER_PORT }}
        run: |
          set -euo pipefail

          # Build image URI and export it so Python can read it from os.environ
          IMAGE_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:latest"
          export IMAGE_URI
          echo "Using image: ${IMAGE_URI}"
          echo "Cluster: ${CLUSTER_NAME}, Service: ${SERVICE_NAME}, TaskFamily: ${TASK_FAMILY}"

          # Show that python3 exists and print its version (debug)
          which python3 || { echo "python3 not found"; exit 1; }
          python3 --version

          # Create taskdef.json using Python (reads IMAGE_URI from env)
          python3 - <<'PY' > taskdef.json
import json, os, sys
try:
    task = {
      "family": os.environ["TASK_FAMILY"],
      "networkMode": "awsvpc",
      "executionRoleArn": f"arn:aws:iam::{os.environ['AWS_ACCOUNT_ID']}:role/ecsTaskExecutionRole",
      "taskRoleArn": f"arn:aws:iam::{os.environ['AWS_ACCOUNT_ID']}:role/ecsTaskExecutionRole",
      "requiresCompatibilities": ["FARGATE"],
      "cpu": "256",
      "memory": "512",
      "containerDefinitions": [
        {
          "name": os.environ["CONTAINER_NAME"],
          "image": os.environ["IMAGE_URI"],
          "portMappings": [{"containerPort": int(os.environ.get("CONTAINER_PORT","80")), "protocol": "tcp"}],
          "essential": True,
          "logConfiguration": {
            "logDriver": "awslogs",
            "options": {
              "awslogs-group": f"/ecs/{os.environ['SERVICE_NAME']}",
              "awslogs-region": os.environ["AWS_REGION"],
              "awslogs-stream-prefix": "ecs"
            }
          }
        }
      ]
    }
except KeyError as e:
    print("Missing environment variable:", e, file=sys.stderr)
    sys.exit(2)

json.dump(task, open("taskdef.json","w"), indent=2)
PY

          # print the generated JSON so you can inspect it in Actions logs
          echo "--- taskdef.json ---"
          cat taskdef.json
          echo "--------------------"

          # Check AWS CLI auth quickly
          aws sts get-caller-identity --region "${AWS_REGION}"

          # Register task definition
          aws ecs register-task-definition --cli-input-json file://taskdef.json

          # Update ECS service (force a new deployment)
          aws ecs update-service --cluster "${CLUSTER_NAME}" --service "${SERVICE_NAME}" --force-new-deployment --region "${AWS_REGION}"
